app:
  image: camptocamp/c2cwsgiutils_test_app:${DOCKER_TAG}
  environment: &app_env
    SQLALCHEMY_URL: postgresql://www-data:www-data@db:5432/test
    SQLALCHEMY_URL_SLAVE: postgresql://www-data:www-data@db_slave:5432/test
    STATS_VIEW: 1
    STATSD_ADDRESS: ${TEST_IP}:8125
    STATSD_PREFIX: acceptance
    LOG_VIEW_SECRET: changeme
    SQL_PROFILER_SECRET: changeme
    DEBUG_VIEW_SECRET: changeme
    LOG_HOST: ${TEST_IP}
    LOG_TYPE: 'console,logstash'
    SQL_LOG_LEVEL: DEBUG
    OTHER_LOG_LEVEL: DEBUG
    DEVELOPMENT: 1
    COVERAGE: 1
    SENTRY_URL: https://14bdb65de3f247c4a89cc7ed53ddec72:6a05548ddef84982958c45fd2a70ff39@sentry.camptocamp.com/5
    C2C_X_VARNISH_OFFSET: -1
  links:
    - db
    - db_slave
  ports:
    - 8480:80

alembic_master:
  image: camptocamp/c2cwsgiutils_test_app:${DOCKER_TAG}
  environment:
    SQLALCHEMY_URL: postgresql://www-data:www-data@db:5432/test
  links:
    - db
  command: /bin/true  # will use execute with another script from the tests to actually do it

alembic_slave:
  image: camptocamp/c2cwsgiutils_test_app:${DOCKER_TAG}
  environment:
    SQLALCHEMY_URL: postgresql://www-data:www-data@db:5432/test
  links:
    - db_slave:db
  command: /bin/true  # will use execute with another script from the tests to actually do it

db:
  image: camptocamp/postgres:9.5
  environment:
    POSTGRES_USER: www-data
    POSTGRES_PASSWORD: www-data
    POSTGRES_DB: test
  command: postgres -c log_line_prefix="%a "
  ports:
    - 15432:5432

db_slave:
  image: camptocamp/postgres:9.5
  environment:
    POSTGRES_USER: www-data
    POSTGRES_PASSWORD: www-data
    POSTGRES_DB: test
  command: postgres -c log_line_prefix="%a " -c log_statement=all
  ports:
    - 25432:5432


run_test:
  image: camptocamp/c2cwsgiutils_test_app:${DOCKER_TAG}
  command: 'true'
  environment: *app_env
  links:
    - db
